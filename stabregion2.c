/* Plot stability regions for multistep methods
   Elmar Klausmeier, 26-May-2025
   Compile like so:
        cc -Wall stabregion2.c -o stabregion2 -lm -llapack -lgsl

Reduced command line flags, 02-Dec-2025
Linear combination logic, 04-Dec-2025
Random combinations, 10-Dec-2025
Testing formulas on y´= lambda y, 14-Dec-2025
Scaled error constant, 06-Jan-2026
*/

#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <math.h>
#include <complex.h>
#include <gsl/gsl_randist.h>


extern float slamch_(char *cmach);
extern double dlamch_(char *cmach);
extern void zggev_(char *jobvl, char *jobvr, int *n, complex *a, int *lda, complex *b,
	int *ldb, complex *alpha, complex *beta, complex *vl, int *ldvl, complex *vr, int *ldvr,
	complex *work, int *lwork, double *rwork, int *info);


#define N	75
#define S	0.0	// Tischer parameter

int debug;

// for LAPACK QZ method
complex a[N*N], b[N*N], alpha[N], beta[N], work[8*N], vl[N*N], vr[N*N];
double eps, rwork[8*N];
int lda=N, ldb=N, ldvl=N, ldvr=N, lwork=N*N, info=0;
char jobvl[8], jobvr[8];


typedef struct {
	const char *name;
	int p;	// order (for information only)
	int k;	// number of start steps, 2*(k+l) = number of rows of a[]
	int l;	// cycle length, i.e., column count of a[]
	double *a;	// transpose of A_i and B_i matrices in a single matrix
} formula_t;

formula_t F[] = {
	{
		"BDF1", 1, 1, 1,
		(double[]){
		-1, 1,
		0, 1 }
	},
	{
		"BDF2", 2, 2, 1,
		(double[]){
		1, -4, 3,
		0, 0, 2 }
	},
	{
		"BDF3", 3, 3, 1,
		(double[]){
		-2, 9, -18, 11,
		0, 0, 0, 6 }
	},
	{
		"BDF4", 4, 4, 1,
		(double[]){
		3, -16, 36, -48, 25,
		0, 0, 0, 0, 12 }
	},
	{
		"BDF5", 5, 5, 1,
		(double[]){
		-12, 75, -200, 300, -300, 137,
		0, 0, 0, 0, 0, 60 }
	},
	{
		"BDF6", 6, 6, 1,
		(double[]){
		10, -72, 225, -400, 450, -360, 147,
		0, 0, 0, 0, 0, 0, 60 }
	},
	{
		"Tendler3", 3, 3, 3,	// name, p, k, l
		(double[]){
		-2, 0, 0,
		9, -2, 0,
		-18, 9, 0,
		11, -18, 9,
		0, 11, -12,
		0, 0, 3,
		// --------
		0, 0, 0,
		0, 0, 0,
		0, 0, 0,
		6, 0, -4,
		0, 6, -4,
		0, 0, 2 }
	},
	{
		"Tendler4", 4, 4, 3,	// name, p, k, l
		(double[]){
		  3 ,    0 ,    0,
		-16 ,    3 ,    0,
		 36 ,  -16 ,   11,
		-48 ,   36 ,  -48,
		 25 ,  -48 ,  216,
		  0 ,   25 , -272,
		  0 ,    0 ,   93,
		// ---------------
		  0 ,    0 ,    0,
		  0 ,    0 ,    0,
		  0 ,    0 ,    0,
		  0 ,    0 ,    0,
		 12 ,    0 ,  -60,
		  0 ,   12 ,  -48,
		  0 ,    0 ,   48 }
	},
	{
		"Tendler5", 5, 5, 4,	// name, p, k, l
		(double[]){
		 -12 ,     0 ,     0 ,     0,
		  75 ,   -12 ,     0 ,     0,
		-200 ,    75 ,  -118 ,     0,
		 300 ,  -200 ,   735 ,  -133,
		-300 ,   300 , -1940 ,   780,
		 137 ,  -300 ,  2980 , -1680,
		   0 ,   137 , -3030 ,  5470,
		   0 ,     0 ,  1373 , -5595,
		   0 ,     0 ,     0 ,  1158,
		// --------------------------
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		  60 ,     0 ,   -60 ,    30,
		   0 ,    60 ,     0 , -1860,
		   0 ,     0 ,   600 , -1530,
		   0 ,     0 ,     0 ,   600 }
	},
	{
		"Tendler6", 6, 6, 4,	// name, p, k, l
		(double[]){
		  10 ,     0 ,     0 ,     0,
		 -72 ,   202 ,     0 ,     0,
		 225 , -1455 ,   195 ,     0,
		-400 ,  4550 , -1399 ,   285,
		 450 , -8100 ,  4340 , -2039,
		-360 ,  9150 , -7540 ,  6225,
		 147 , -7277 ,  8905 ,-10360,
		   0 ,  2930 , -7445 , 18455,
		   0 ,     0 ,  2944 ,-14865,
		   0 ,     0 ,     0 ,  2299,
		// --------------------------
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		   0 ,     0 ,     0 ,     0,
		  60 ,   -60 ,  -420 ,   180,
		   0 ,  1200 ,   -60 , -4080,
		   0 ,     0 ,  1200 , -4680,
		   0 ,     0 ,     0 ,  1200 }
	},
	{
		"Tendler7", 7, 7, 4,	// name, p, k, l
		(double[]){
		  -60 ,     0 ,     0 ,     0,
		  490 ,   -60 ,     0 ,     0,
		-1764 ,   490 ,  -210 ,     0,
		 3675 , -1764 ,  1722 ,  -774,
		-4900 ,  3675 , -6235 ,  6349,
		 4410 , -4900 , 13100 ,-22988,
		-2940 ,  4410 ,-17650 , 48160,
		 1089 , -2940 , 17710 ,-66290,
		    0 ,  1089 ,-11297 , 68159,
		    0 ,     0 ,  2860 ,-42364,
		    0 ,     0 ,     0 ,  9748,
		// ---------------------------
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		    0 ,     0 ,     0 ,     0,
		  420 ,     0 ,  -600 ,   840,
		    0 ,   420 , -1860 , -2100,
		    0 ,     0 ,  1200 , -8400,
		    0 ,     0 ,     0 ,  4200 }
	},
	{
		"Tischer2", 2, 2, 2,	// name, p, k, l
		(double[]){
		0.2713503499466539, S * 0.2713503499466539,
		-1.271350349946654, S * -1.271350349946654,
		1, -1 + S,
		0, 1,
		// --------
		-0.06067517497332695, -0.04894502624599904 + S * (-0.06067517497332695),
		0.2143248250266731, 0.1728900524919981 + S * 0.2143248250266731,
		0.575, 0.3010549737540010 + S * 0.575,
		0, 0.575 }
	},
	{
		"Tischer3", 3, 3, 2,	// name, p, k, l
		(double[]){
		-0.7156809323463300, S * (-0.7156809323463300),
		2.421409496232843, S * 2.421409496232843,
		-2.705728563886513, 0.4195749238763092 + S *(-2.705728563886513),
		1, -1.419574923876309 + S,
		0, 1,
		// --------
		-0.8629888978651531, 1.894838801355351+ S * (-0.8629888978651531),
		3.166634912306544, -6.952885160409694+ S * 3.166634912306544,
		-4.013693645981575, 9.231466454815180 + S * (-4.013693645981575),
		1.72, -5.312995019637147 + S * 1.72,
		0, 1.72 }
	},
	{
		"Tischer4", 4, 4, 2,	// name, p, k, l
		(double[]){
		0.6103461100271559, S * 0.6103461100271559,
		-2.747685823192436, S * (-2.747685823192436),
		4.670005693524193, -0.2716147139534076 + S * 4.670005693524193,
		-3.532665980358913, 1.222768338553090 + S * (-3.532665980358913),
		1, -1.951153624599682 + S,
		0, 1,
		// --------
		0.9215366381763085, -2.649958179621567 + S * 0.9215366381763085,
		-4.136159579898865, 11.89388403771322 + S * (-4.136159579898865),
		7.141520549769378, -20.89280076921304 + S * 7.141520549769378,
		-5.652569985267611, 17.85562740240295 + S * (-5.652569985267611),
		1.72, -7.606291401927840 + S * 1.72,
		0, 1.72 }
	},
	{
		"Tischer5", 5, 5, 2,	// name, p, k, l
		(double[]){
		-0.5473524843400159, S * (-0.5473524843400159),
		3.046981165805116, S * 3.046981165805116,
		-6.842547445085438, 0.2023989966807180 + S * (-6.842547445085438),
		7.741845845969376, -1.126707101014822 + S * 7.741845845969376,
		-4.398927082349038, 2.473981498420040 + S * (-4.398927082349038),
		1, -2.549673394085936 + S,
		0, 1,
		// --------
		-0.8285692507199495, 2.569479392269974 + S * (-0.8285692507199495),
		4.523688780360865, -14.02842923277731 + S * 4.523688780360865,
		-10.05367226203171, 31.45494082222007 + S * (-10.05367226203171),
		11.42213178164391, -36.93603791002108 + S * 11.42213178164391,
		-6.661863565106905, 23.96920129089773 + S * (-6.661863565106905),
		1.59, -8.446918649021926 + S * 1.59,
		0, 1.59 }
	},
	{
		"Tischer6", 6, 6, 2,	// name, p, k, l
		(double[]){
		0.5065949241573893, S * 0.5065949241573893,
		-3.347588901033099, S * (-3.347588901033099),
		9.288264853658161, -0.1622565792899431 + S * 9.288264853658161,
		-13.85423667736953, 1.072194564235031 + S * (-13.85423667736953),
		11.70833137691048, -2.943247343299985+ S * 11.70833137691048,
		-5.301365576323402, 4.228025197181846 + S * (-5.301365576323402),
		1, -3.194715838826949 + S,
		0, 1,
		// --------
		0.6632827080818050, -1.966557927018182 + S * 0.6632827080818050,
		-4.318145132370032, 12.80281007873031 + S * (-4.318145132370032),
		11.87138330994840, -35.39751311755192 + S * 11.87138330994840,
		-17.69684560038281, 53.77255375657074 + S * (-17.69684560038281),
		15.14109874111104, -48.44295713982840 + S * 15.14109874111104,
		-7.068045626188859, 26.08926183188078 + S * (-7.068045626188859),
		1.4, -8.166685368910522 + S * 1.4,
		0, 1.4 }
	},
	{
		"Tischer7", 7, 7, 2,	// name, p, k, l
		(double[]){
		-0.4730377247001383, S * (-0.4730377247001383),
		3.614094099926330, S * 3.614094099926330,
		-11.91361867598596, 0.1354428064536342 + S * (-11.91361867598596),
		21.97700424011387, -1.034807631868773 + S * 21.97700424011387,
		-24.50710155920918, 3.390826065383960 + S * (-24.50710155920918),
		16.51027888261980, -6.137117459840426 + S * 16.51027888261980,
		-6.207619262764723, 6.516126407008639 + S * (-6.207619262764723),
		1, -3.870470187137034 + S,
		0, 1,
		// --------
		-0.5593384312526297, 1.627202025358370+ S * (-0.5593384312526297),
		4.220709442337714, -12.27869670539260 + S * 4.220709442337714,
		-13.79410919873106, 40.28383410923075 + S * (-13.79410919873106),
		25.36722912840438, -74.96406486441271 + S * 25.36722912840438,
		-28.42514847816480, 86.48642725198855 + S * (-28.42514847816480),
		19.46252654187500, -63.47949128834042 + S * 19.46252654187500,
		-7.551726936498641, 29.33643618328776 + S * (-7.551726936498641),
		1.275, -8.238999899992440 + S * 1.275,
		0, 1.275 }
	},
	{
		"Tischer8", 8, 8, 2,	// name, p, k, l
		(double[]){
		0.4453348513468461, S * 0.4453348513468461,
		-3.859180665772141, S * (-3.859180665772141),
		14.71642002045547, -0.1162654110659919 + S * 14.71642002045547,
		-32.27324489323404, 1.007532253824141 + S * (-32.27324489323404),
		44.53945382773937, -3.827901007455769 + S * 44.53945382773937,
		-39.61766259292482, 8.302866483037190 + S * (-39.61766259292482),
		22.16853315999479, -11.16589138289488 + S * 22.16853315999479,
		-7.119653707605472, 9.369883714651345 + S * (-7.119653707605472),
		1, -4.570224650096031 + S,
		0, 1,
		// --------
		0.4822252401396465, -1.384350259109908 + S * 0.4822252401396465,
		-4.136942315524837, 11.87614560523851 + S * (-4.136942315524837),
		15.65983206216709, -45.07917311093609 + S * 15.65983206216709,
		-34.21855612352479, 99.29376589604582 + S * (-34.21855612352479),
		47.30113434219221, -139.7912993045485 + S * 47.30113434219221,
		-42.45139314249457, 130.5230230565463 + S * (-42.45139314249457),
		24.20929805095255, -81.18525412979233 + S * 24.20929805095255,
		-8.028548065406828, 33.00040235056584 + S * (-8.028548065406828),
		1.18, -8.408425274884485 + S * 1.275,
		0, 1.18 }
	},
	{
		"Mihelcic4", 4, 3, 2,	// name, p, k, l
		(double[]){
		0.635, 0,
		4.08, -21299.0 / 63500,
		-5.715, 0.288,
		1, -60489.0 / 63500,
		0, 1,
		// --------
		0, 0,
		-653.0 / 200, 4203.0 / 25400,
		-1.63, 10527.0 / 127000,
		109.0 / 200, 94929.0 / 127000,
		0, 0.387 }
	},
	{
		"Mihelcic5", 5, 3, 3,	// name, p, k, l
		(double[]){
		1.473, 0, 0,
		8.784, -1.369091006228046872693999232562, 0,
		-13.257, 2.544, 0.363,
		3, -2.174908993771953127306000767438, -2.160,
		0, 1, -1.203,
		0, 0, 3,
		// --------
		0, 0, 0,
		-7.347, 0.6040303354093489575646664108540, 0,
		-2.874, 0.2391213416373958302586656434162, -0.086,
		1.491, -0.1299696645906510424353335891459, 0.061,
		0, 0.481, 3.424,
		0, 0, 1.035 }
	},
	{
		"Mihelcic6", 6, 4, 4,	// name, p, k, l
		(double[]){
		-0.9390362339466378776258361005001e-01,                                      0,                                      0,                                      0,
		 0.2307741600964885363988695519087e+00,  0.1313792557365642037980205785897e+01,                                      0,                                      0,
		 0.6362705032057367094700091337420e+00, -0.5218540536524916920611801547836e+01,  0.1394364937701534512038572085087e+00,                                      0,
		-0.1773141039907661458106295075601e+01,  0.7529417145415851180555472647834e+01, -0.1011623223444230192358671688990e+01,  0.1444191297888636803281533656209e+01,
		 1,                                     -0.4624669166256576297923876885895e+01,  0.2533821653452779618403940682161e+01, -0.5492130726047090045832910083724e+01,
		 0,                                      1,                                     -0.2661634923778702877249126201679e+01,  0.7660459268273149438357977410280e+01,
		 0,                                      0,                                      1,                                     -0.4612519840114696195806600982764e+01,
		 0,                                      0,                                      0,                                     1,
		// ------------------------------------------------------------------------------------------------------------------------------------------------------------
		-0.1853058013316520953710176130202e-02,                                      0,                                      0,                                      0,
		 0.2451624610656680441199165441716e+00, -0.6428104226828121021947147465023e+00,                                      0,                                      0,
		-0.9774386604306546531165819680760e+00,  0.1217442120880404165141230674303e+01, -0.1234001277245579249775694769490e+00,                                      0,
		 0.5535769499829904561071401752847e+00,  0.2924405192057778509076307429902e+00,  0.6120300247935214387198741562141e+00, -0.6918619210365557047027968203354e+00,
		 0.3644443541805902548632380173403e+00, -0.1439373462587944161697640697511e+01, -0.8155238085505402874283164469721e+00,  0.1168008238715629118739713863798e+01,
		 0,                                      0.5385875007216307945710071168686e+00, -0.1145523605965158361286500199803e-01,  0.4386358816535462908082534556190e+00,
		 0,                                                                          0,  0.4094644596664487699907078389984e+00, -0.1467449527693897117841289393376e+01,
		 0,                                                                          0,                                      0,  0.5438956185163976564593606928377e+00 }
	},
	{
		"Mihelcic7", 7, 5, 5,	// name, p, k, l
		(double[]){
		-0.8153861905026022737434167615414e+00,                                      0,                                      0,                                      0,                                      0,
		 0.4248895254033088383481894572139e+01, -0.2222441760654655361593826056284e-01,                                      0,                                      0,                                      0,
		-0.8854047951365927037900576200388e+01,  0.2654870121454308294304980610591e+00, -0.1032372883543017869086260071380e+00,                                      0,                                      0,
		 0.9222953551982948533098094387068e+01, -0.1205209745869234199415093321373e+01,  0.8599203816315797312780689738287e+00, -0.4503824855570349203575243869964e+00,                                      0,
		-0.4802414664147507604935996997277e+01,  0.2592699276978907532702377400625e+01, -0.2778518172270275904802809146576e+01,  0.2649630382099203346956766040160e+01,  0.3219958911202349451261006329238e-02,
		 1,                                     -0.2630752125658557609101843879749e+01,  0.4366928200996645755541775423194e+01, -0.6226227266320010195981550682429e+01,  0.1553984660531454990906076870577e-01,
		 0,                                      1,                                     -0.3345093122003647795108409243309e+01,  0.7304031887973224464306216642665e+01, -0.4533196816782826816679836557976e+00,
		 0,                                      0,                                      1,                                     -0.4277052518195382694923907613400e+01,  0.1691723344964800813261126750020e+01,
		 0,                                      0,                                      0,                                      1,                                     -0.2257163468803035030953464869257e+01,
		 0,                                      0,                                      0,                                      0,                                      1,
		// ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
		 0.4225456071360219714271811811639e+00,                                      0,                                      0,                                      0,                                      0,
		-0.1384364739812333541090764922689e+01,  0.5044748643224129949603468040808e-01,                                      0,                                      0,                                      0,
		 0.1146229672531143866569110401229e+01, -0.3550507135730755767219599244966e+00,  0.1003502539567659420767582244072e+00,                                      0,                                      0,
		 0.6542124190961045586099091344395e+00,  0.9776848659097670987554894143623e+00, -0.6085349671365743688808169611528e+00,  0.2643442532041219470801194385611e+00,                                      0,
		-0.1322701573944066648938040619221e+01, -0.1124773012768567816507929091140e+01,  0.1286689084300843479379774302352e+01, -0.1081991130901289033649461985260e+01,  0.3096249379217892308281396122901e-01,
		 0.4840799656531792806536461685364e+00,  0.1917873380953330674263870885019e+00, -0.9223533515854392440249726038524e+00,  0.1354222521191408219378646232897e+01, -0.2269170368480450921510442892867e+00,
		 0,                                      0.3700608846337565198520459335580e+00, -0.2298469653682757407333327433246e+00, -0.9237493311630675659214627664954e-01,  0.7904598622265127771615281344478e+00,
		 0,                                      0,                                      0.3969920978990539400467297585933e+00, -0.8904512454964667161729702886816e+00, -0.1202094468615905428211278510487e+01,
		 0,                                      0,                                      0,                                      0.4473119757158579081724970288316e+00,  0.4061703817752004671762456256483e+00,
		 0,                                      0,                                      0,                                      0,                                      0.3568354106010698554863523086895e+00 }
	},
	{
		"DonelsonHansen1", 5, 3, 3,	// name, p, k, l
		(double[]){
		0, 0, 0,
		-57, 1083, 0,
		24, -456, 0,
		33, -1347, -57,
		0, 720, 24,
		0, 0, 33,
		// --------
		-1, 0, 0,
		24, -350, 0,
		57, -1347, -1,
		10, 456, 24,
		0, 251, 57,
		0, 0, 10 }
	},
	{
		"DonelsonHansen2", 6, 3, 3,	// name, p, k, l
		(double[]){
		-11, 0, 0,
		-27, 188, 0,
		27, -36, 25,
		11, -252, -63,
		0, 100, -9,
		0, 0, 47,
		// --------
		3, 0, 0,
		27, -60, 0,
		27, -252, -9,
		3, 36, -9,
		0, 36, 63,
		0, 0, 15 }
	},
	{
		"DonelsonHansen3", 6, 3, 3,	// name, p, k, l
		(double[]){
		0, 0, 0,
		-57, 136, 0,
		24, -117, -283,
		33, -144, -306,
		0, 125, 531,
		0, 0, 58,
		// --------
		-1, 0, 0,
		24, -45, 0,
		57, -144, 84,
		10, 117, 531,
		0, 42, 306,
		0, 0, 9 }
	},
	{
		"DonelsonHansen4", 5, 3, 2,	// name, p, k, l
		(double[]){
		0, 0,
		-57, 31,
		24, -12,
		33, -39,
		0, 20,
		// --------
		-1, 0,
		24, -10,
		57, -39,
		10, 12,
		0, 7 }
	},
	{
		"DonelsonHansen5", 7, 4, 4,	// name, p, k, l
		(double[]){
		    0,      0,      0,      0,
		-1360,  13409,      0,      0,
		-1350,  30384,   3653,      0,
		 2160, -55026, -22752,   4550,
		  550,   2224, -45792,  14160,
		    0,   9009,  49888, -14850,
		    0,      0,  15003,  -5360,
		    0,      0,      0,   1500,
		// ---------------------------
		   -9,      0,      0,      0,
		  456,  -3585,      0,      0,
		 2376, -32904,  -1182,      0,
		 1656, -19008,   1440,  -1191,
		  141,  16008,  49032, -12456,
		    0,   2529,  42144, -13176,
		    0,      0,   3906,    744,
		    0,      0,      0,    459 }
	},
	{
		"DonelsonHansen6", 8, 4, 4,	// name, p, k, l
		(double[]){
		    0,      0,         0,         0,
		-1360,   4603,         0,         0,
		-1350,   1008,  -3455657,         0,
		 2160, -28242, -28102272,     59160,
		  550,  15728,  -5942052,    175440,
		    0,   6903,  31623488,   -201690,
		    0,      0,   5876493,    -55920,
		    0,      0,         0,     23010,
		// ---------------------------------
		   -9,      0,         0,         0,
		  456,  -1293,         0,         0,
		 2376,  -8136,    789744,         0,
		 1656,   9936,  15276816,    -15543,
		  141,  16968,  40314888,   -159048,
		    0,   1845,  20558640,   -156168,
		    0,      0,   1449972,     20232,
		    0,      0,         0,      6867 }
	},
	{
		"Rubin1", 4, 2, 2,	// name, p, k, l
		(double[]){
		0, 56,
		24, -72,
		-24, 0,
		0, 16,
		// -------
		1, -21,
		-13, -39,
		-13, 33,
		1, 3 }
	},
	{
		"Rubin2", 5, 2, 3,	// name, p, k, l
		(double[]){
		  53280, 2960, -3060,
		-149040, -8280, 400,
		95760, 0, 0,
		0, 5320, 0,
		0, 0, 2660,
		// -------------------
		-21101, -1091, 967,
		-1786, -646, 4142,
		80184, 7824, 1272,
		-17686, 1574, 3842,
		2869, 19, 817 }
	},
	{
		"Rubin3", 7, 2, 5,	// name, p, k, l
		(double[]){
		60480, 0, -83160, -3592512, 31752000,
		-181440, -3780, -280000, -12096000, -63129024,
		120960, 0, 0, 0, 0,
		0, 3780, 0, 0, 0,
		0, 0, 363160, 0, 0,
		0, 0, 0, 15688512, 0,
		0, 0, 0, 0, 31377024,
		// ------------------------------------------------------
		-20813, -37, 21543, 1000955, -10734025,
		-14856, 1398, 233496, 9545400, -19553640,
		140439, 4863, 362667, 17560575, 54547275,
		-70016, 1328, 404352, 13251200, 21814400,
		34809, 33, 160437, 19119825, 27147525,
		-10488, -30, -10776, 6052680, 41821800,
		1405, 5, 921, -184075, 10089785 }
	},
	{
		"Rubin4", 7, 2, 4,	// name, p, k, l
		(double[]){
		720, -67680, -4230, 186912,
		-7200, -714240, -44640, -304200,
		6480, 0, 0, 0,
		0, 781920, 0, 0,
		0, 0, 48870, 0,
		0, 0, 0, 117288,
		// -----------------------------
		-359, 13637, 479, -61655,
		2153, 362461, 25267, -148735,
		4998, 952926, 50802, 270390,
		-1402, 318046, 54562, -10,
		433, -16819, 20567, 189265,
		-63, 1269, -837, 32985 }
	},
	{
		"Rubin5", 7, 2, 4,	// name, p, k, l
		(double[]){
		-24390, -800, -1755, 4608,
		-53280, -7830, -2560, -12375,
		77670, 0, 0, 0,
		0, 8630, 0, 0,
		0, 0, 4315, 0,
		0, 0, 0, 7767,
		// --------------------------
		6589, 168, 498, -1520,
		58528, 4053, 3600, -2150,
		41608, 10488, 3720, 13600,
		-5752, 3528, 5280, 2600,
		1223, -192, 1650, 11600,
		-136, 15, -48, 2330 }
	},
	{
		"Rubin6", 6, 2, 4,	// name, p, k, l
		(double[]){
		-3529798560, -17279332000, -22318068240, -80345045664,
		3964033440, 18389043360, 23601172000, 84964219200,
		-434234880, 0, 0, 0,
		0, -1109711360, 0, 0,
		0, 0, -1283103760, 0,
		0, 0, 0, -4619173536,
		// -----------------------------------------------------
		1172485179, 5712109779, 7385920983, 26502706035,
		3305843699, 16704113739, 21563247183, 78182632235,
		-2264282846, -10981264206, -13763304822, -51094037390,
		1259302434, 5364552114, 6074978058, 24429713010,
		-447285581, -2063589621, -3234606417, -16222055765,
		69500795, 323987475, 442521975, 69393395 }
	},
	{
		"Picel2", 2, 1, 2,	// name, p, k, l
		(double[]){
		-1, 1,
		 0, -4,
		 1, 3,
		// ----
		 0, 0,
		 2, 0,
		 0, 2 }
	},
	{
		"Picel3", 3, 1, 3,	// name, p, k, l
		(double[]){
		-2,  1, -2,
		-3, -6, 9,
		 6,  3, -18,
		-1,  2, 11,
		// ---------
		 0,  0, 0,
		 6,  0, 0,
		 0,  6, 0,
		 0,  0, 6 }
	},
	{
		"Picel4", 4, 1, 4,	// name, p, k, l
		(double[]){
		-6, 2, -2, 6,
		-20, -16, 12, -32,
		 36, 0, -36, 72,
		-12, 16, 20, -96,
		  2, -2, 6, 50,
		// ---------------
		0, 0, 0, 0,
		24, 0, 0, 0,
		0, 24, 0, 0,
		0, 0, 24, 0,
		0, 0, 0, 24 }
	},
	{
		"Picel5", 5, 1, 5,	// name, p, k, l
		(double[]){
		-24, 6, -4, 6, -24,
		-130, -60, 30, -40, 150,
		240, -40, -120, 120, -400,
		-120, 120, 40, -240, 600,
		40, -30, 60, 130, -600,
		-6, 4, -6, 24, 274,
		// -----------------------
		0, 0, 0, 0, 0,
		120, 0, 0, 0, 0,
		0, 120, 0, 0, 0,
		0, 0, 120, 0, 0,
		0, 0, 0, 120, 0,
		0, 0, 0, 0, 120 }
	},
	{
		"Picel6", 6, 1, 6,	// name, p, k, l
		(double[]){
		-120, 24, -12, 12, -24, 120,
		-924, -288, 108, -96, 180, -864,
		1800, -420, -540, 360, -600, 2700,
		-1200, 960, 0, -960, 1200, -4800,
		600, -360, 540, 420, -1800, 5400,
		-180, 96, -108, 288, 924, -4320,
		24, -12, 12, -24, 120, 1764,
		// -------------------------------
		0, 0, 0, 0, 0, 0,
		720, 0, 0, 0, 0, 0,
		0, 720, 0, 0, 0, 0,
		0, 0, 720, 0, 0, 0,
		0, 0, 0, 720, 0, 0,
		0, 0, 0, 0, 720, 0,
		0, 0, 0, 0, 0, 720 }
	},
	{
		"Picel7", 7, 1, 7,	// name, p, k, l
		(double[]){
		-720, 120, -48, 36, -48, 120, -720,
		-7308, -1680, 504, -336, 420, -1008, 5880,
		15120, -3948, -3024, 1512, -1680, 3780, -21168,
		-12600, 8400, -1260, -5040, 4200, -8400, 44100,
		8400, -4200, 5040, 1260, -8400, 12600, -58800,
		-3780, 1680, -1512, 3024, 3948, -15120, 52920,
		1008, -420, 336, -504, 1680, 7308, -35280,
		-120, 48, -36, 48, -120, 720, 13068,
		// --------------------------------------------
		0, 0, 0, 0, 0, 0, 0,
		5040, 0, 0, 0, 0, 0, 0,
		0, 5040, 0, 0, 0, 0, 0,
		0, 0, 5040, 0, 0, 0, 0,
		0, 0, 0, 5040, 0, 0, 0,
		0, 0, 0, 0, 5040, 0, 0,
		0, 0, 0, 0, 0, 5040, 0,
		0, 0, 0, 0, 0, 0, 5040 }
	},
	{
		"Picel8", 8, 1, 8,	// name, p, k, l
		(double[]){
		-5040, 720, -240, 144, -144, 240, -720, 5040,
		-64224, -11520, 2880, -1536, 1440, -2304, 6720, -46080,
		141120, -38304, -20160, 8064, -6720, 10080, -28224, 188160,
		-141120, 80640, -18144, -32256, 20160, -26880, 70560, -451584,
		117600, -50400, 50400, 0, -50400, 50400, -117600, 705600,
		-70560, 26880, -20160, 32256, 18144, -80640, 141120, -752640,
		28224, -10080, 6720, -8064, 20160, 38304, -141120, 564480,
		-6720, 2304, -1440, 1536, -2880, 11520, 64224, -322560,
		720, -240, 144, -144, 240, -720, 5040, 109584,
		// -----------------------------------------------------------
		0, 0, 0, 0, 0, 0, 0, 0,
		40320, 0, 0, 0, 0, 0, 0, 0,
		0, 40320, 0, 0, 0, 0, 0, 0,
		0, 0, 40320, 0, 0, 0, 0, 0,
		0, 0, 0, 40320, 0, 0, 0, 0,
		0, 0, 0, 0, 40320, 0, 0, 0,
		0, 0, 0, 0, 0, 40320, 0, 0,
		0, 0, 0, 0, 0, 0, 40320, 0,
		0, 0, 0, 0, 0, 0, 0, 40320 }
	},
	{
		"Picel9", 9, 1, 9,	// name, p, k, l
		(double[]){
		-40320, 5040, -1440, 720, -576, 720, -1440, 5040, -40320,
		-623376, -90720, 19440, -8640, 6480, -7776, 15120, -51840, 408240,
		1451520, -396576, -155520, 51840, -34560, 38880, -72576, 241920, -1866240,
		-1693440, 846720, -223776, -241920, 120960, -120960, 211680, -677376, 5080320,
		1693440, -635040, 544320, -72576, -362880, 272160, -423360, 1270080, -9144576,
		-1270080, 423360, -272160, 362880, 72576, -544320, 635040, -1693440, 11430720,
		677376, -211680, 120960, -120960, 241920, 223776, -846720, 1693440, -10160640,
		-241920, 72576, -38880, 34560, -51840, 155520, 396576, -1451520, 6531840,
		51840, -15120, 7776, -6480, 8640, -19440, 90720, 623376, -3265920,
		-5040, 1440, -720, 576, -720, 1440, -5040, 40320, 1026576,
		// ---------------------------------------------------------------------------
		0, 0, 0, 0, 0, 0, 0, 0, 0,
		362880, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 362880, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 362880, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 362880, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 362880, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 362880, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 362880, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 362880, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 362880 }
	},
	{
		"Picel10", 10, 1, 10,	// name, p, k, l
		(double[]){
		-362880, 40320, -10080, 4320, -2880, 2880, -4320, 10080, -40320, 362880,
		-6636960, -806400, 151200, -57600, 36000, -34560, 50400, -115200, 453600, -4032000,
		16329600, -4419360, -1360800, 388800, -216000, 194400, -272160, 604800, -2332800, 20412000,
		-21772800, 9676800, -2756160, -2073600, 864000, -691200, 907200, -1935360, 7257600, -62208000,
		25401600, -8467200, 6350400, -1330560, -3024000, 1814400, -2116800, 4233600, -15240960, 127008000,
		-22861440, 6773760, -3810240, 4354560, 0, -4354560, 3810240, -6773760, 22861440, -182891520,
		15240960, -4233600, 2116800, -1814400, 3024000, 1330560, -6350400, 8467200, -25401600, 190512000,
		-7257600, 1935360, -907200, 691200, -864000, 2073600, 2756160, -9676800, 21772800, -145152000,
		2332800, -604800, 272160, -194400, 216000, -388800, 1360800, 4419360, -16329600, 81648000,
		-453600, 115200, -50400, 34560, -36000, 57600, -151200, 806400, 6636960, -36288000,
		40320, -10080, 4320, -2880, 2880, -4320, 10080, -40320, 362880, 10628640,
		// -----------------------------------------------------------------------------------------------
		0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		3628800, 0, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 3628800, 0, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 3628800, 0, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 3628800, 0, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 3628800, 0, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 3628800, 0, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 3628800, 0, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 3628800, 0, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 3628800, 0,
		0, 0, 0, 0, 0, 0, 0, 0, 0, 3628800 }
	},
	{
		"eTendler3", 3, 3, 3,	// name, p, k, l
		(double[]){
		  -2,	   0,	   0,
		   9,	-153,	   0,
		 -18,	 750,	 -23,
		  11,	-1131,	 966,
		   0,	 534,	-1365,
		   0,	   0,	 422,
		// -------------------
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		   6,	-246,	-384,
		   0,	 336,	-378,
		   0,	   0,	 264 }
	},
	{
		"eTendler4", 4, 4, 3,	// name, p, k, l
		(double[]){
		   3,	   0,	   0,
		 -16,	  16,	   0,
		  36,	 -90,	  15,
		 -48,	 234,	 -94,
		  25,	-214,	 162,
		   0,	  54,	-114,
		   0,	   0,	  31,
		// ------------------
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		  12,	 -84,	  48,
		   0,	  36,	 -60,
		   0,	   0,	  24 }
	},
	{
		"eTendler5", 5, 5, 3,	// name, p, k, l
		(double[]){
		 -12,	   0,	   0,
		  75,	 -66,	   0,
		-200,	 425,	 -93,
		 300,	-1200,	 615,
		-300,	2100,	-1880,
		 137,	-1550,	2460,
		   0,	 291,	-1515,
		   0,	   0,	 413,
		// -------------------
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		   0,	   0,	   0,
		  60,	-600,	 540,
		   0,	 180,	-540,
		   0,	   0,	 240 }
	},
	{
		"eTendler6", 6, 6, 4,	// name, p, k, l
		(double[]){
		  10,	   0,	   0,	   0,
		 -72,	  38,	   0,	   0,
		 225,	-276,	 145,	   0,
		-400,	 875,	-1054,	  41,
		 450,	-1600,	3350,	-289,
		-360,	1950,	-6200,	 830,
		 147,	-1388,	7075,	-1880,
		   0,	 401,	-4970,	2935,
		   0,	   0,	1654,	-1991,
		   0,	   0,	   0,	 354,
		// ---------------------------
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		  60,	-240,	 300,	 300,
		   0,	 180,	-600,	-240,
		   0,	   0,	 720,	-600,
		   0,	   0,	   0,	 180 }
	},
	{
		"eTendler7", 7, 7, 4,	// name, p, k, l
		(double[]){
		 -60,	   0,	   0,	   0,
		 490,	-280,	   0,	   0,
		-1764,	2310,	-270,	   0,
		3675,	-8442,	2233,	-474,
		-4900,	18025,	-8197,	3920,
		4410,	-25200,	17675,	-14413,
		-2940,	25830,	-25550,	31430,
		1089,	-14910,	23695,	-42770,
		   0,	2667,	-12383,	36904,
		   0,	   0,	2797,	-20615,
		   0,	   0,	   0,	6018,
		// ---------------------------
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		 420,	-4200,	2100,	-1680,
		   0,	1260,	-2940,	3360,
		   0,	   0,	1260,	-2940,
		   0,	   0,	   0,	2520 }
	},
	{
		"eTendler8", 8, 8, 4,	// name, p, k, l
		(double[]){
		 105,	   0,	   0,	   0,
		-960,	10560,	   0,	   0,
		3920,	-96740,	4350,	   0,
		-9408,	396116,	-40060,	11580,
		14700,	-954618,	165256,	-106094,
		-15680,	1501850,	-402822,	434406,
		11760,	-1623860,	646450,	-1046346,
		-6720,	1267140,	-731500,	1640450,
		2283,	-701166,	591360,	-1801730,
		   0,	200718,	-290706,	1438794,
		   0,	   0,	57672,	-782406,
		   0,	   0,	   0,	211346,
		// -------------------------------------
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,
		 840,	-56280,	25200,	21000,
		   0,	76440,	-64680,	2520,
		   0,	   0,	24360,	-81480,
		   0,	   0,	   0,	81480 }
	},
	{
		"eTendler9", 9, 9, 5,	// name, p, k, l
		(double[]){
		-280,	   0,	   0,	   0,	   0,
		2835,	-5285,	   0,	   0,	   0,
		-12960,	53730,	-13715,	   0,	   0,
		35280,	-246960,	138885,	-24780,	   0,
		-63504,	677376,	-634992,	250764,	-22331,
		79380,	-1233036,	1728720,	-1145544,	225768,
		-70560,	1569960,	-3111108,	3115434,	-1029642,
		45360,	-1446480,	3883740,	-5600364,	2789808,
		-22680,	1028160,	-3422160,	6991530,	-4946214,
		7129,	-486351,	2295792,	-6110664,	6531756,
		   0,	88886,	-1194345,	3889494,	-5933718,
		   0,	   0,	329183,	-2019384,	3364992,
		   0,	   0,	   0,	653514,	-1609983,
		   0,	   0,	   0,	   0,	629564,
		// ---------------------------------------------------------
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		   0,	   0,	   0,	   0,	   0,
		2520,	-98280,	-80640,	-40320,	-241920,
		   0,	35280,	-63000,	-73080,	-168840,
		   0,	   0,	118440,	35280,	171360,
		   0,	   0,	   0,	229320,	171360,
		   0,	   0,	   0,	   0,	216720 }
	}
};

#define NF	(sizeof(F) / sizeof(F[0]))


formula_t B[] = {
	{
		"Base3", 3, 3, 4,	// name, p, k, l
		(double[]){
		// ------------------
		-11,   -2,   1,   -2,
		 18,   -3,  -6,    9,
		 -9,    6,   3,  -18,
		  2,   -1,   2,   11,
		// ------------------
		  6,    0,   0,    0,
		  0,    6,   0,    0,
		  0,    0,   6,    0,
		  0,    0,   0,    6 }
	},
	{
		"Base4", 4, 4, 5,	// name, p, k, l
		(double[]){
		// -------------------------
		-25,   -3,    1,   -1,    3,
		 48,  -10,   -8,    6,  -16,
		-36,   18,    0,  -18,   36,
		 16,   -6,    8,   10,  -48,
		 -3,    1,   -1,    3,   25,
		// -------------------------
		 12,    0,    0,    0,    0,
		  0,   12,    0,    0,    0,
		  0,    0,   12,    0,    0,
		  0,    0,    0,   12,    0,
		  0,    0,    0,    0,   12 }
	},
	{
		"Base5", 5, 5, 6,	// name, p, k, l
		(double[]){
		// -------------------------------------
		-137,   -12,     3,    -2,     3,   -12,
		 300,   -65,   -30,    15,   -20,    75,
		-300,   120,   -20,   -60,    60,  -200,
		 200,   -60,    60,    20,  -120,   300,
		 -75,    20,   -15,    30,    65,  -300,
		  12,    -3,     2,    -3,    12,   137,
		// -------------------------------------
		  60,     0,     0,     0,     0,     0,
		   0,    60,     0,     0,     0,     0,
		   0,     0,    60,     0,     0,     0,
		   0,     0,     0,    60,     0,     0,
		   0,     0,     0,     0,    60,     0,
		   0,     0,     0,     0,     0,    60 }
	},
	{
		"Base6", 6, 6, 7,	// name, p, k, l
		(double[]){
		// --------------------------------------------
		-147,   -10,     2,    -1,     1,    -2,    10,
		 360,   -77,   -24,     9,    -8,    15,   -72,
		-450,   150,   -35,   -45,    30,   -50,   225,
		 400,  -100,    80,     0,   -80,   100,  -400,
		-225,    50,   -30,    45,    35,  -150,   450,
		  72,   -15,     8,    -9,    24,    77,  -360,
		 -10,     2,    -1,     1,    -2,    10,   147,
		// --------------------------------------------
		  60,     0,     0,     0,     0,     0,     0,
		   0,    60,     0,     0,     0,     0,     0,
		   0,     0,    60,     0,     0,     0,     0,
		   0,     0,     0,    60,     0,     0,     0,
		   0,     0,     0,     0,    60,     0,     0,
		   0,     0,     0,     0,     0,    60,     0,
		   0,     0,     0,     0,     0,     0,    60 }
	},
	{
		"Base7", 7, 7, 8,	// name, p, k, l
		(double[]){
		// -----------------------------------------------------------
		-1089,    -60,     10,     -4,      3,     -4,     10,    -60,
		 2940,   -609,   -140,     42,    -28,     35,    -84,    490,
		-4410,   1260,   -329,   -252,    126,   -140,    315,  -1764,
		 4900,  -1050,    700,   -105,   -420,    350,   -700,   3675,
		-3675,    700,   -350,    420,    105,   -700,   1050,  -4900,
		 1764,   -315,    140,   -126,    252,    329,  -1260,   4410,
		 -490,     84,    -35,     28,    -42,    140,    609,  -2940,
		   60,    -10,      4,     -3,      4,    -10,     60,   1089,
		// -----------------------------------------------------------
		  420,      0,      0,      0,      0,      0,      0,      0,
		    0,    420,      0,      0,      0,      0,      0,      0,
		    0,      0,    420,      0,      0,      0,      0,      0,
		    0,      0,      0,    420,      0,      0,      0,      0,
		    0,      0,      0,      0,    420,      0,      0,      0,
		    0,      0,      0,      0,      0,    420,      0,      0,
		    0,      0,      0,      0,      0,      0,    420,      0,
		    0,      0,      0,      0,      0,      0,      0,    420 }
	},
	{
		"Base8", 8, 8, 9,	// name, p, k, l
		(double[]){
		// ----------------------------------------------------------------------------
		 -2283,    -105,      15,      -5,       3,      -3,       5,     -15,     105,
		  6720,   -1338,    -240,      60,     -32,      30,     -48,     140,    -960,
		-11760,    2940,    -798,    -420,     168,    -140,     210,    -588,    3920,
		 15680,   -2940,    1680,    -378,    -672,     420,    -560,    1470,   -9408,
		-14700,    2450,   -1050,    1050,       0,   -1050,    1050,   -2450,   14700,
		  9408,   -1470,     560,    -420,     672,     378,   -1680,    2940,  -15680,
		 -3920,     588,    -210,     140,    -168,     420,     798,   -2940,   11760,
		   960,    -140,      48,     -30,      32,     -60,     240,    1338,   -6720,
		  -105,      15,      -5,       3,      -3,       5,     -15,     105,    2283,
		// ----------------------------------------------------------------------------
		   840,       0,       0,       0,       0,       0,       0,       0,       0,
		     0,     840,       0,       0,       0,       0,       0,       0,       0,
		     0,       0,     840,       0,       0,       0,       0,       0,       0,
		     0,       0,       0,     840,       0,       0,       0,       0,       0,
		     0,       0,       0,       0,     840,       0,       0,       0,       0,
		     0,       0,       0,       0,       0,     840,       0,       0,       0,
		     0,       0,       0,       0,       0,       0,     840,       0,       0,
		     0,       0,       0,       0,       0,       0,       0,     840,       0,
		     0,       0,       0,       0,       0,       0,       0,       0,     840 }
	},
	{
		"Base9", 9, 9, 10,	// name, p, k, l
		(double[]){
		// -------------------------------------------------------------------------------------
		 -7129,    -280,      35,     -10,       5,      -4,       5,     -10,      35,    -280,
		 22680,   -4329,    -630,     135,     -60,      45,     -54,     105,    -360,    2835,
		-45360,   10080,   -2754,   -1080,     360,    -240,     270,    -504,    1680,  -12960,
		 70560,  -11760,    5880,   -1554,   -1680,     840,    -840,    1470,   -4704,   35280,
		-79380,   11760,   -4410,    3780,    -504,   -2520,    1890,   -2940,    8820,  -63504,
		 63504,   -8820,    2940,   -1890,    2520,     504,   -3780,    4410,  -11760,   79380,
		-35280,    4704,   -1470,     840,    -840,    1680,    1554,   -5880,   11760,  -70560,
		 12960,   -1680,     504,    -270,     240,    -360,    1080,    2754,  -10080,   45360,
		 -2835,     360,    -105,      54,     -45,      60,    -135,     630,    4329,  -22680,
		   280,     -35,      10,      -5,       4,      -5,      10,     -35,     280,    7129,
		// -------------------------------------------------------------------------------------
		  2520,       0,       0,       0,       0,       0,       0,       0,       0,       0,
		     0,    2520,       0,       0,       0,       0,       0,       0,       0,       0,
		     0,       0,    2520,       0,       0,       0,       0,       0,       0,       0,
		     0,       0,       0,    2520,       0,       0,       0,       0,       0,       0,
		     0,       0,       0,       0,    2520,       0,       0,       0,       0,       0,
		     0,       0,       0,       0,       0,    2520,       0,       0,       0,       0,
		     0,       0,       0,       0,       0,       0,    2520,       0,       0,       0,
		     0,       0,       0,       0,       0,       0,       0,    2520,       0,       0,
		     0,       0,       0,       0,       0,       0,       0,       0,    2520,       0,
		     0,       0,       0,       0,       0,       0,       0,       0,       0,    2520 }
	}
};


#define NB	(sizeof(B) / sizeof(B[0]))



void printmat(const char *s, double a[], int n) {
	int i, j;
	puts(s);
	for (i=0; i<n; ++i) {
		printf("\t");
		for (j=0; j<n; ++j)
			printf("%13.5f",a[i+j*n]);
		puts("");
	}
}



typedef void (*prtf_t)(int i, complex lambda, double xmin, double widlw);


void plainOutput(int i, complex lambda, double xmin, double widlw) {
	printf("\t%5d\t%16.8f\t%16.8f,\t%9.5f\t%9.5f\n",i,creal(lambda),cimag(lambda),xmin,widlw);
}



void jsOutput(int i, complex lambda, double xmin, double widlw) {
	printf("\t[%.8f, %.8f],\n",creal(lambda),cimag(lambda));
}



void js3d(int i, complex lambda, double xmin, double widlw) {
	printf("\t[%.8f, %.8f, 1],\n",creal(lambda),cimag(lambda));
}

void printFormulas (formula_t F[], int nf) {
	int i, j, k, l, n, nu, i1, i2, i3, n2, iqm1, q, qfac, flag;
	double rho1, alphaii, t;
	long double rho1sum, rho1c, t1, t2, rho1arr[2*N];
	const char *marker[3] = { "", "\t<-----", "\t<+++++" };

	// Print out all formulas
	for (i=0; i<nf; ++i) {
		l = F[i].l;
		printf("%s, p=%d, k=%d, l=%d\n",F[i].name,F[i].p,F[i].k,l);
		n = 2 * (F[i].k + l);
		for (k=0; k<n; ++k) {
			printf("\t");
			for (j=0; j<l; ++j)
				printf("%15.4f",F[i].a[k*l+j]);
			puts("");
		}
		printf("rho_0\t");	// rho(1)=0, that's what it should be
		flag = 0;
		for (j=0; j<l; ++j) {
			rho1 = 0;
			n = F[i].k + F[i].l;
			for (k=0; k<n; ++k)
				rho1 += F[i].a[k*l+j];
			if (rho1 != 0) flag = 1;
			printf("%22.9f",(double)rho1);
		}
		puts(flag ? "\t<-----" : "");
		// Compute consistency check up to the order of the formula
		qfac = 1;	// factorial
		for (q=1; q<=F[i].p+1; ++q) {
			qfac *= q;
			printf("rho_%d\t",q);	// rho_q = \sum \alpha_i i^q - q \sum \beta_i i^{q-1}, should be zero
			flag = 0;
			n = F[i].k + F[i].l; n2 = 2 * n;
			for (j=0; j<l; ++j) {
				rho1 = 0.0; rho1sum = 0.0;
				if ((alphaii = F[i].a[(F[i].k+j)*l+j]) == 0) { flag = 2; alphaii = 1; }
				for (k=0; k<n; ++k) {
					iqm1 = 1; // iq = 1;
					for (nu=1; nu<q; ++nu) iqm1 *= k;
					//iq = iqm1 * k;
					//rho1 += (long double)F[i].a[k*l+j] * iq - q * (long double)F[i].a[(n+k)*l+j] * iqm1;
					//rho1 += ((long double)F[i].a[k*l+j] * k - (long double)F[i].a[(n+k)*l+j] * q) * iqm1;
					//rho1 += ((long double)F[i].a[k*l+j] / alphaii * k - (long double)F[i].a[(n+k)*l+j] / alphaii * q) * iqm1;
					rho1arr[2*k] = (long double)F[i].a[k*l+j] * (long double)k * (long double)iqm1;
					rho1arr[2*k+1] = -(long double)F[i].a[(n+k)*l+j] * (long double)q * (long double)iqm1;
				}
				for (i1=n2/2; i1>0; i1/=2)	// Shell sort, K&R, §3.5, p.55
					for (i2=i1; i2<n2; ++i2)
						for (i3=i2-i1; i3>=0 && fabsl(rho1arr[i3])>fabsl(rho1arr[i3+i1]); i3-=i1) {
							t = rho1arr[i3];
							rho1arr[i3] = rho1arr[i3+i1];
							rho1arr[i3+i1] = t;
						}
				//printf(">> ");
				//for (i1=0; i1<n2; ++i1) printf(" %g",rho1arr[i1]);
				//printf("\n");
				rho1c = 0.0;	// Kahan's summation, rho1c is compensation
				for (i1=0; i1<n2; ++i1) {
					t1 = rho1arr[i1] - rho1c;
					t2 = rho1sum + t1;
					rho1c = (t2 - rho1sum) - t1;
					rho1sum = t2;
				}
				rho1 = rho1sum;
				if (flag == 0 && rho1 != 0) flag = 1;
				//printf("<%22.9f,%d,%g>",rho1, qfac, alphaii);
				printf(" %22.9f",rho1 / qfac / alphaii);
			}
			//puts(flag ? "\t<-----" : "");
			puts(marker[flag]);
		}
	}
}



// Fill the four square A0, A1 and B1, B2 matrices: A1 y(yn+1) + A0 y(n) = B1 z(n+1) + B0 z(n)
// Matrices in column order, i.e., Fortran mode for later use by zzgev_
void fillMatrices (formula_t *fm, double a0[], double a1[], double b0[], double b1[], int *nOut, int *nsqOut) {
	int colLen, i, j, n, nsq, nrest, rest;

	if (fm->k >= fm->l) {
		rest = fm->k - fm->l,
		n = fm->k;
		//nrest = fm->l,
		//nsq = fm->k * fm->k;
	} else {
		rest = fm->l - fm->k,	//rest = fm->k,
		n = fm->l;	//n = fm->l + fm->k;
		//nrest = fm->l,	// nrest = fm->k,
		//nsq = n * n;	//nsq = fm->l * fm->l;
	}
	if (n >= N) {
		printf("error in fillMatrices(): n=%d equals or exceeds N=%d\n",n,N);
		exit(14);
	}
	nrest = fm->l;
	nsq = n * n;
	colLen = 2 * (fm->k + fm->l);

	memset(a0,0,sizeof(*a0) * nsq);	// set a0[] to zero matrix
	memset(a1,0,sizeof(*a1) * nsq);	// set a1[] to zero matrix
	memset(b0,0,sizeof(*b0) * nsq);	// set b0[] to zero matrix
	memset(b1,0,sizeof(*b1) * nsq);	// set b1[] to zero matrix
	if (debug) printf("k=%d, l=%d, rest=%d, n=%d, nrest=%d, nsq=%d, colLen=%d\n",fm->k,fm->l,rest,n,nrest,nsq,colLen);
	if (fm->k >= fm->l) {
		for (i=0; i<rest; ++i) {
			a1[i+i*n] = 1;	// fill with parts of identity matrix
			if (i + nrest < n) a0[i+(i+nrest)*n] = -1;	// cancel out
		}
		for (i=rest; i<n; ++i) {
			for (j=0; j<n; ++j)
				a0[i+j*n] = fm->a[(i-rest)+j*fm->l],
				b0[i+j*n] = fm->a[(i-rest)+((j+fm->l)+n)*fm->l];
			for (j=rest; j<n; ++j)
				a1[i+j*n] = fm->a[(i-rest)+((j-rest)+n)*fm->l],
				b1[i+j*n] = fm->a[(i-rest)+((j-rest+fm->l)+2*n)*fm->l];
		}
	} else {
		for (i=0; i<n; ++i) {
			for (j=0; j<n; ++j)
				a1[i+j*n] = fm->a[i+(j+fm->k)*fm->l],
				b1[i+j*n] = fm->a[i+(j+2*fm->k+n)*fm->l];
			for (j=rest; j<n; ++j)
				a0[i+j*n] = fm->a[i+(j-rest)*fm->l],
				b0[i+j*n] = fm->a[i+(j-rest+fm->k+fm->l)*fm->l];
		}
#if 0
		for (i=fm->k; i<n; ++i) {
			for (j=0; j<fm->k; ++j)
				a0[i+j*n] = fm->a[(i-fm->k)+j*fm->l], //fm->a[(i-fm->k)+((j-fm->k)+n)*fm->l],
				b0[i+j*n] = fm->a[(i-fm->k)+(j+n)*fm->l]; //fm->a[(i-fm->k)+((j-fm->k+fm->l)+2*n)*fm->l];
			for (j=fm->k; j<n; ++j)
				a1[i+j*n] = fm->a[(i-fm->k)+j*fm->l],
				b1[i+j*n] = fm->a[(i-fm->k)+(j+n)*fm->l];
		}
#endif
	}

	if (debug) {
		// Print A1, A0, B1, B0
		puts(fm->name);
		printmat("A1",a1,n);
		printmat("A0",a0,n);
		printmat("B1",b1,n);
		printmat("B0",b0,n);
	}

	*nOut = n,
	*nsqOut = nsq;
}



formula_t *initFormula (char *fname, formula_t *bm, double lnc[]) {
	int cpLen, il = 0, i, j, l;
	formula_t *fm;
	FILE *fp;

	if (bm == NULL) {
		printf("No base formula specified, bm==NULL\n");
		return NULL;
	}
	cpLen = 2 * (bm->k + 1);	// row length of base formula in bm[]
	if (debug) {
		printf("%s, p=%d, k=%d, l=%d, cpLen=%d\n",bm->name, bm->p, bm->k, bm->l, cpLen);
		for (i=0; i<cpLen; ++i) {
			for (j=0; j<bm->l; ++j)
				printf("\t%13.8f",bm->a[i*bm->l + j]);
			printf("\n");
		}
	}

	if (fname[0] == '\0' || (fname[0] == '-' && fname[1] == '\0')) fp = stdin;
	else if ((fp = fopen(fname,"r")) == NULL) {
		printf("Cannot open %s\n",fname);
		return NULL;
	}

	while (fscanf(fp,"%lf",&lnc[il]) != EOF)
		++il;
	if (fp != stdin && fclose(fp)) {
		printf("Cannot close file %s\n",fname);
		return NULL;
	}

	l = sqrt(2*il - 1);	// cycle length l
	if (2 * il != l * (l + 1)) {
		printf("linear combinations not in triangular format, il=%d, l=%d\n", il, l);
		return NULL;
	}
	if (debug) {
		printf("fname=%s, l=%d, il=%d\n",fname,l,il);
		for (i=0; i<l; ++i) {
			for (j=0; j<=i; ++j)
				printf("\t%13.8f",lnc[i*(i+1)/2 + j]);
			printf("\n");
		}
	}

	if ((fm = calloc(1,sizeof(formula_t))) == NULL) return NULL;
	if ((fm->a = calloc(l * 2 * (bm->k + l), sizeof(double))) == NULL) return NULL;
	fm->name = "LinearCombination";
	fm->p = bm->p;
	fm->k = bm->k;
	fm->l = l;

	return fm;
}



// See https://eklausmeier.goip.de/dyn/blog/2025/01-07-praktische-gewinnung-zyklischer-steif-stabiler-verfahren#Basisformeln
// Compute fm from bm using lnc[]
void linearComb (formula_t *bm, formula_t *fm, double lnc[]) {
	int colLen, cpLen, i, j, k, l=fm->l;

	cpLen = 2 * (bm->k + 1);	// row length of base formula in bm[]

	memset(fm->a,0,sizeof(fm->a[0]) * 2 * (fm->k + fm->l) * fm->l);	// set a[] to zero matrix
	for (i=0; i<cpLen; ++i)
		for (j=0; j<l; ++j)
			for (k=0; k<=j; ++k)
				fm->a[((i > bm->k + 1 ? i+l-1 : i)+j)*l+j] += lnc[j*(j+1)/2 + k] * bm->a[i * bm->l + (bm->l - k - 1)];

	if (debug) {
		colLen = 2 * (fm->k + fm->l);	// row length of target formula
		printf("fm based on %s, l=%d, colLen=%d\n",fm->name,fm->l,colLen);
		for (i=0; i<colLen; ++i) {
			for (j=0; j<l; ++j)
				printf("\t%13.8f",fm->a[i*l+j]);
			printf("\n");
		}
	}
}



void parasiticRoots (int n, int nsq, double a0[], double a1[], int print, formula_t *fm) {
	int i, j, nu;
	double lambdaLen;
	complex lambda;

	// parasitic roots for rho
	for (j=0; j<nsq; ++j)	// rho(lambda) = A1 lambda + A0 = 0, therefore A0 x = -lambda A1 x
		a[j] = a0[j],
		b[j] = 0 - a1[j];
	info = 0;
	zggev_(jobvl, jobvr, &n, a, &lda, b, &ldb, alpha, beta, vl, &ldvl, vr, &ldvr, work, &lwork, rwork, &info);
	if (info) printf("parasitic roots: zggev_.info=%d\n",info);
	for (j=0; j<n; ++j)
		if (beta[j] == 0) alpha[j] = 0, rwork[j] = 0, rwork[j] = 0;	// illegal
		else alpha[j] /= beta[j], rwork[j] = cabs(alpha[j]);	// alpha = eigenvalue, rwork = absolute value
	for (nu=n/2; nu>0; nu/=2)	// Shell sort, K&R, §3.5, p.55
		for (i=nu; i<n; ++i)
			for (j=i-nu; j>=0 && rwork[j]<rwork[j+nu]; j-=nu) {
				lambdaLen = rwork[j];
				rwork[j] = rwork[j+nu];
				rwork[j+nu] = lambdaLen;
				lambda = alpha[j];
				alpha[j] = alpha[j+nu];
				alpha[j+nu] = lambda;
			}

	if (print) {
		printf("Parasitic roots of %s\n\t%-5s\t%-16s\t%-16s\t%-16s\t%d-th root\n",fm->name,"nr","real","imag","abs",fm->l);
		for (j=0; j<n; ++j)
			printf("\t%5d%16.8f\t%16.8f\t%16.8f\t%18.8f\n",j,creal(alpha[j]),cimag(alpha[j]),rwork[j],pow(rwork[j],1.0/fm->l));
	}
}



void lambdaLocus (int n, int nsq, int nr, double widlwMin, double a0[], double a1[], double b0[], double b1[],
	double *xminOut, double *xmaxOut, double *ymaxOut, double *widlwOut, prtf_t prtf) {
	int i, j;
	double xmin = 0, xmax = 0, ymax = 0, widlw = 90;
	double phi, phiinc, rlambda, ilambda;
	complex eiphi, lambda;

	for (i=0,phiinc=2*M_PI/nr,phi=0; i<nr; phi+=phiinc,++i) {
		eiphi = cexp(I * phi);
		for (j=0; j<nsq; ++j)	// A = A1 e^{i\phi} + A0, same for B
			a[j] = a1[j] * eiphi + a0[j],
			b[j] = b1[j] * eiphi + b0[j];
		info = 0;
		zggev_(jobvl, jobvr, &n, a, &lda, b, &ldb, alpha, beta, vl, &ldvl, vr, &ldvr, work, &lwork, rwork, &info);
		if (info) printf("phi=%f, zggev_.info=%d\n",phi,info);
		for (j=0; j<n; ++j) {
			if (beta[j] == 0) continue;
			lambda = alpha[j] / beta[j];
			rlambda = creal(lambda),
			ilambda = cimag(lambda),
			xmin = fmin(xmin,rlambda),	// Widlund distance delta
			xmax = fmax(xmax,rlambda),
			ymax = fmax(ymax,fabs(ilambda));
			if (rlambda < 0
			&&  fabs(rlambda) > eps && fabs(ilambda) > eps)
				widlw = fmin(widlw,180/M_PI*fabs(atan(ilambda/rlambda)));	// Widlund wedge in degrees
			if (prtf) prtf(i,lambda,xmin,widlw);
			if (widlwMin > 0 && widlw < widlwMin) goto L;
		}
	}

L:
	*xminOut = xmin,
	*xmaxOut = xmax,
	*ymaxOut = ymax,
	*widlwOut = widlw;
}



void lambda3D (int n, int nsq, int nr, double xmin, double xmax, double ymax, double a0[], double a1[], double b0[], double b1[]) {
	int j;
	double x, y, xstep, ystep, abslambda;

	xmin = -1.4 * fmax(fabs(xmin),xmax),
	xmax = 1.1 * xmax,
	ymax = 1.1 * ymax,
	nr = 4.1 * sqrt(nr);
	xstep = (xmax - xmin) / nr, ystep = 2 * ymax / nr;

	for (x=xmin; x<=xmax; x+=xstep) {
		for (y=-ymax; y<=ymax; y+=ystep) {
			for (j=0; j<nsq; ++j)
				a[j] = a0[j] - (x+I*y) * b0[j],
				b[j] = (x+I*y) * b1[j] - a1[j];
#if 0
			for (i=0; i<n; ++i) {
				printf("\t\t");
				for (j=0; j<n; ++j)
					printf(" (%.4f,%.4f)",creal(a[i+j*n]),cimag(a[i+j*n]));
				printf("\n");
			}
			for (i=0; i<n; ++i) {
				printf("\t\t");
				for (j=0; j<n; ++j)
					printf(" (%.4f,%.4f)",creal(b[i+j*n]),cimag(b[i+j*n]));
				printf("\n");
			}
#endif
			info = 0;
			zggev_(jobvl, jobvr, &n, a, &lda, b, &ldb, alpha, beta, vl, &ldvl, vr, &ldvr, work, &lwork, rwork, &info);
			if (info) printf("zggev_.info=%d\n",info);
			for (j=0; j<n; ++j) {
				//printf("alpha[%d]=(%.6f,%.6f), beta[%d]=(%.6f,%.6f)\n",j,creal(alpha[j]),cimag(alpha[j]),j,creal(beta[j]),cimag(beta[j]));
				if (beta[j] == 0) continue;
				//if (cabs(beta[j]) <= eps) continue;
				abslambda = cabs(alpha[j] / beta[j]);
				if (abslambda > 2.3) abslambda = 2.3;
				printf("\t[%.8f, %.8f, %.8f],\n", x, y, abslambda);
			}
		}
	}
}



void checkLinearComb (formula_t *bm, formula_t *fm, int nr, int il, double lnc[], double widlwMin, double a0[], double a1[],double b0[],double b1[], int *cnt, int print) {
	int k, n, nsq;
	double xmin, xmax, ymax, widlw, parasitic;

	linearComb(bm,fm,lnc);
	fillMatrices(fm,a0,a1,b0,b1,&n,&nsq);
	lda = n, ldb = n, ldvl = n, ldvr = n, lwork = n*n;
	if (lwork <= 1) lwork = 8;

	parasiticRoots(n,nsq,a0,a1,0,fm);
	if (debug) printf("rwork[0]=%f, rwork[1]=%f\n",rwork[0],rwork[1]);
	if (rwork[0] <= 1.0 && n>1 && rwork[1] <= 0.75 && nr > 0) {
		parasitic = rwork[1];
		lambdaLocus(n,nsq,nr,widlwMin,a0,a1,b0,b1,&xmin,&xmax,&ymax,&widlw,NULL);
		if (debug) printf("\twidlw=%f\n",widlw);
		if (widlw >= widlwMin) {
			printf("W=%9.5f, xmin=%9.5f, parasitic=%6.4f\t",widlw,xmin,parasitic);
			for (k=0; k<il; ++k) printf(" %13.6f",lnc[k]);
			printf("\t\t%d\n",++*cnt);
		}
	}
}



void searchComb (formula_t *bm, formula_t *fm, int nr, double lnc0[], double widlwMin,
	double a0[], double a1[], double b0[], double b1[], double start, double stop, double step, int print) {
	int i, k, cnt=0, il;
	double lnc[N * (N+1) / 2 + 4];	// linear combination coefficients

	il = fm->l * (fm->l + 1) / 2;	// number of elements in lnc[]
	lnc[0] = lnc0[0];
	for (i=1; i<il; ++i) lnc[i] = lnc0[i] + start;

	for (;;) {
		if (debug) {
			printf("d\t");
			for (k=0; k<il; ++k) printf("%12.4f",lnc[k]);
			printf("\n");
		}
		checkLinearComb(bm,fm,nr,il,lnc,widlwMin,a0,a1,b0,b1,&cnt,print);

		for (i=il-1; i>=1; --i) {
			if (lnc[i] < lnc[0] + stop) {
				lnc[i] += step;
				break;
			} else {
				lnc[i] = lnc0[i] + start;
				if (i == 1) return;
			}
		}
	}

}



void randomComb (formula_t *bm, int nr, int l, int niter, double lnc[], double widlwMin,
	double a0[], double a1[], double b0[], double b1[], double start, double stop, int print) {
	int i, j, cnt=0, il;
	unsigned long seed;
	FILE *fp;
	formula_t *fm;
	const gsl_rng_type *T;
	gsl_rng *r;

	if ((fp = fopen("/dev/urandom","r")) == NULL) {
		printf("Cannot open /dev/urandom\n");
		return;
	}
	if (fread(&seed,sizeof(unsigned long),1,fp) != 1) {
		printf("Cannot read from /dev/urandom\n");
		return;
	}
	if (fclose(fp)) {
		printf("Cannot close /dev/urandom\n");
		return;
	}

	if ((fm = calloc(1,sizeof(formula_t))) == NULL) {
		printf("randomComb(): Cannot allocate fm\n");
		return;
	}
	if ((fm->a = calloc(l * 2 * (bm->k + l), sizeof(double))) == NULL) {
		printf("randomComb(): Cannot allocate fm->a for %d double records\n",l * 2 * (bm->k + l));
		return;
	}
	fm->name = "RandomCombination";
	fm->p = bm->p;
	fm->k = bm->k;
	fm->l = l;
	il = fm->l * (fm->l + 1) / 2;	// number of elements in lnc[]

	gsl_rng_env_setup();
	T = gsl_rng_default;
	r = gsl_rng_alloc(T);
	if (debug) printf("seed = %ld\n",seed);
	gsl_rng_set(r,seed);

	lnc[0] = 1;
	for (i=0; i<niter; ++i) {
		for (j=1; j<il; ++j)
			lnc[j] = gsl_ran_flat(r,start,stop);
		checkLinearComb(bm,fm,nr,il,lnc,widlwMin,a0,a1,b0,b1,&cnt,print);
	}

	gsl_rng_free(r);
}



void solveTestEqSingle (formula_t *fm, float radius, float phi, float start, float stop, float step) {
	int i, j, imk, m, mcnt, n;
	char cmach[8];
	float t, err, feps, gerr=0;
	float complex lambda, hlambda, y[N], z[N], yexact;

	cmach[0] = 'E';
	feps = 65536 * slamch_(cmach);

	t = start;
	lambda = radius * cexp(I * phi * M_PI / 180);
	printf("formula=%s, radius=%g, phi=%g, lambda=(%1g,%g), start=%g, stop=%g, step=%g, feps=%g\n",fm->name,radius,phi,creal(lambda),cimag(lambda),start,stop,step,feps);
	hlambda = step * lambda;
	stop *= 1.0 + feps;
	for (i=0; i<fm->k; ++i) {	// k start values
		y[i] = cexpf(lambda * t),	// exact values as starting values
		z[i] = hlambda * y[i];	// z = h f(t,y)
		printf("%9d  %16.8f %16.8f  %16.8f  %16.8f\n",i+1,t,crealf(y[i]),cimagf(y[i]),cabsf(y[i]));
		t += step;
	}

	mcnt = fm->k;
	n = fm->k + fm->l;
	if (n >= N) {
		printf("error in solveTestEqSingle(): n=%d equals or exceeds N=%d\n",n,N);
		exit(15);
	}
	printf("%-9s  %16s  %16s  %16s  %16s  %16s  %16s\n",
		"step","t", "Re(y)", "Im(y)", "|err|", "|global err|", "gerr/step");
	while ((step > 0 && t <= stop) || (step < 0 && t >= stop)) {
		for (i=fm->k; i<n; ++i) {
			m = mcnt % n, y[m] = 0, z[m] = 0, imk = i - fm->k;
			for (j=0; j<i; ++j) {	// index gymnastics
				y[m] += fm->a[imk+j*fm->l] * y[(mcnt-i+j)%n],
				z[m] += fm->a[imk+(j+n)*fm->l] * z[(mcnt-i+j)%n];
			}
			y[m] = (z[m] - y[m]) / (fm->a[imk+i*fm->l] - hlambda * fm->a[imk+(i+n)*fm->l]),
			z[m] = hlambda * y[m];
			yexact = cexpf(lambda * t);
			err = cabsf(y[m] - yexact),
			gerr += err;
			++mcnt;
			printf("%9d  %16.8f  %16.8g  %16.8g  %16.8g %16.8g  %16.8g\n",
				mcnt,t, crealf(y[m]),cimagf(y[m]), err,gerr,gerr/mcnt);
			t += step;
		}
	}
}



void solveTestEq (formula_t *fm, double radius, double phi, double start, double stop, double step) {
	int i, j, imk, m, mcnt, n;
	double t, err, gerr=0;
	complex lambda, hlambda, y[N], z[N], yexact;

	t = start;
	lambda = radius * cexp(I * phi * M_PI / 180);
	printf("formula=%s, radius=%g, phi=%g, lambda=(%1g,%g), start=%g, stop=%g, step=%g, eps=%g\n",fm->name,radius,phi,creal(lambda),cimag(lambda),start,stop,step,eps);
	hlambda = step * lambda;
	stop *= 1 + 2 * eps;
	for (i=0; i<fm->k; ++i) {	// k start values
		y[i] = cexp(lambda * t),	// exact values as starting values
		z[i] = hlambda * y[i];	// z = h f(t,y)
		printf("%9d  %16.8f %16.8f  %16.8f  %16.8f\n",i+1,t,creal(y[i]),cimag(y[i]),cabs(y[i]));
		t += step;
	}

	mcnt = fm->k;
	n = fm->k + fm->l;
	if (n >= N) {
		printf("error in solveTestEq(): n=%d equals or exceeds N=%d\n",n,N);
		exit(16);
	}
	printf("%-9s  %16s  %16s  %16s  %16s  %16s  %16s\n",
		"step","t", "Re(y)", "Im(y)", "|err|", "|global err|", "gerr/step");
	while ((step > 0 && t <= stop) || (step < 0 && t >= stop)) {
		for (i=fm->k; i<n; ++i) {
			m = mcnt % n, y[m] = 0, z[m] = 0, imk = i - fm->k;
			for (j=0; j<i; ++j) {	// index gymnastics
				y[m] += fm->a[imk+j*fm->l] * y[(mcnt-i+j)%n],
				z[m] += fm->a[imk+(j+n)*fm->l] * z[(mcnt-i+j)%n];
				//printf("> m=%d, imk=%d, (mcnt-i+j)%%n=%d, a[%d]=%f -- a[%d]=%f\n",
				//	m,imk,(mcnt-i+j)%n,imk+j*fm->l,fm->a[imk+j*fm->l], imk+(j+n)*fm->l,fm->a[imk+(j+n)*fm->l]);
			}
			//printf("> i=%d, a[%d]=%f - a[%d]=%f\n",i,imk+i*fm->l,fm->a[imk+i*fm->l],imk+(i+n)*fm->l,fm->a[imk+(i+n)*fm->l]);
			y[m] = (z[m] - y[m]) / (fm->a[imk+i*fm->l] - hlambda * fm->a[imk+(i+n)*fm->l]),
			z[m] = hlambda * y[m];
			yexact = cexp(lambda * t);
			err = cabs(y[m] - yexact),
			gerr += err;
			++mcnt;
			//printf("%9d  %16.8f  %16.8f  %16.8f  %16.8f %16.8f  %16.8f\n",
			printf("%9d  %16.8f  %16.8g  %16.8g  %16.8g %16.8g  %16.8g\n",
				mcnt,t, creal(y[m]),cimag(y[m]), err,gerr,gerr/mcnt);
			t += step;
		}
	}
}



void solveRunge (formula_t *fm, double start, double stop, double step) {
	int i, j, imk, m, mcnt, n;
	double t, tdenom, hft, err, gerr=0, y[N], z[N], yexact;

	t = start;
	printf("formula=%s, start=%g, stop=%g, step=%g, eps=%g\n",fm->name,start,stop,step,eps);
	stop *= 1 + 2 * eps;
	for (i=0; i<fm->k; ++i) {	// k start values
		y[i] = 1 / (1 + t * t),	// exact values as starting values
		tdenom = 1 + t * t;
		z[i] = -2 * step * t / (tdenom * tdenom) ;	// z = h f(t,y)
		printf("%9d  %16.8f  %16.8f\n",i+1,t,y[i]);
		t += step;
	}

	mcnt = fm->k;
	n = fm->k + fm->l;
	if (n >= N) {
		printf("error in solveRunge(): n=%d equals or exceeds N=%d\n",n,N);
		exit(17);
	}
	printf("%-9s  %16s  %16s  %16s  %16s  %16s\n",
		"step","t", "y", "|err|", "|global err|", "gerr/step");
	while ((step > 0 && t <= stop) || (step < 0 && t >= stop)) {
		for (i=fm->k; i<n; ++i) {
			m = mcnt % n, y[m] = 0, z[m] = 0, imk = i - fm->k;
			for (j=0; j<i; ++j) {	// index gymnastics
				y[m] += fm->a[imk+j*fm->l] * y[(mcnt-i+j)%n],
				z[m] += fm->a[imk+(j+n)*fm->l] * z[(mcnt-i+j)%n];
			}
			tdenom = 1 + t * t;
			hft = -2 * step * t / (tdenom * tdenom);
			y[m] = (fm->a[imk+(i+n)*fm->l] * hft - y[m] + z[m]) / fm->a[imk+i*fm->l];
			z[m] = hft;
			yexact = 1 / (1 + t * t);
			err = fabs(y[m] - yexact),
			gerr += err;
			++mcnt;
			printf("%9d  %16.8f  %16.8g  %16.8g  %16.8g  %16.8g\n",
				mcnt,t, y[m], err,gerr,gerr/mcnt);
			t += step;
		}
	}
}



void solveRungeQuad (formula_t *fm, double start, double stop, double step) {
	int i, j, imk, m, mcnt, n;
	long double t, tdenom, hft, err, gerr=0, y[N], z[N], yexact;

	t = start;
	printf("formula=%s, start=%g, stop=%g, step=%g, eps=%g\n",fm->name,start,stop,step,eps);
	stop *= 1 + 2 * eps;
	for (i=0; i<fm->k; ++i) {	// k start values
		y[i] = 1 / (1 + t * t),	// exact values as starting values
		tdenom = 1 + t * t;
		z[i] = -2 * step * t / (tdenom * tdenom) ;	// z = h f(t,y)
		printf("%9d  %16.8f  %16.8f\n",i+1,(double)t,(double)y[i]);
		t += step;
	}

	mcnt = fm->k;
	n = fm->k + fm->l;
	if (n >= N) {
		printf("error in solveRunge(): n=%d equals or exceeds N=%d\n",n,N);
		exit(17);
	}
	printf("%-9s  %16s  %16s  %16s  %16s  %16s\n",
		"step","t", "y", "|err|", "|global err|", "gerr/step");
	while ((step > 0 && t <= stop) || (step < 0 && t >= stop)) {
		for (i=fm->k; i<n; ++i) {
			m = mcnt % n, y[m] = 0, z[m] = 0, imk = i - fm->k;
			for (j=0; j<i; ++j) {	// index gymnastics
				y[m] += fm->a[imk+j*fm->l] * y[(mcnt-i+j)%n],
				z[m] += fm->a[imk+(j+n)*fm->l] * z[(mcnt-i+j)%n];
			}
			tdenom = 1 + t * t;
			hft = -2 * step * t / (tdenom * tdenom);
			y[m] = (fm->a[imk+(i+n)*fm->l] * hft - y[m] + z[m]) / fm->a[imk+i*fm->l];
			z[m] = hft;
			yexact = 1 / (1 + t * t);
			err = fabs(y[m] - yexact),
			gerr += err;
			++mcnt;
			printf("%9d  %16.8f  %16.8g  %16.8g  %16.8g  %16.8g\n",
				mcnt,(double)t, (double)y[m], (double)err,(double)gerr,(double)gerr/mcnt);
			t += step;
		}
	}
}



int main (int argc, char *argv[]) {
	int c, i, n, nr=20, nsq, outp='p', print=1, task=0, cycleLen=3, niter=100, prec=0;
	char *fname = NULL;
	char cmach[8];
	formula_t *fm = NULL, *bm = NULL;
	double lnc[N * (N+1) / 2 + 4];	// linear combination coefficients, lower triangular matrix, initially read from file
	double xmin, xmax, ymax, widlw=0, a0[N*N], a1[N*N], b0[N*N], b1[N*N], start=-50, stop=50, step=5, radius, phi;
	prtf_t prtf = plainOutput;

	while ((c = getopt(argc,argv,"b:f:dhi:I:l:o:r:t:u:W:")) != -1) {
		switch(c) {
		case 'b':	// step numbers of base formulas
			for (i=0; i<NB; ++i)	// linear search for formula
				if (strcmp(optarg,B[i].name) == 0) {
					bm = &B[i];
					break;
				}
			if (bm == NULL) {
				printf("%s: base formula %s not found\n",argv[0],optarg);
				return 1;
			}
			break;
		case 'f':	// name of formula
			for (i=0; i<NF; ++i)	// linear search for formula
				if (strcmp(optarg,F[i].name) == 0) {
					fm = &F[i];
					break;
				}
			if (fm == NULL) {
				printf("%s: formula %s not found\n",argv[0],optarg);
				return 1;
			}
			break;
		case 'd':
			debug = 1;
			break;
		case 'h':
			printf("%s: compute stability regions for various formulas.\n"
			"-b: base formula, Base3-9\n"
			"-f: formulas: BDF1-6, DonelsonHansen1-6, Mihelcic4-7, Tischer2-8, Tendler3-7, eTendler3-9, Picel2-10, Rubin1-6\n"
			"-d: debug\n"
			"-h: this help\n"
			"-I <cycle-length>:<min>:<max>:<max iterations> random search in linear combinations\n"
			"-i <start>:<stop>:<step> incremental search through linear combinations\n"
			"-l: file name with linear combinations for the base formula\n"
			"-o: output format in either 'p' (plain) or 'j' (Javascript) or '3' (3-dimensional)\n"
			"-r: number of records\n"
			"-t <prec>:<radius>:<phi>:t0:t1:h testing formula for y'=lambda y,\n\tfrom t0 to t1 using stepsize h (lambda = r e^(i phi)\n"
			"-u <prec>:t0:t1:h testing formula for y'=-2t/(1+t^2)^2,\n\tfrom t0 to t1 using stepsize h\n"
			"-W: minimal Widlund wedge\n", argv[0]);
			return 0;
		case 'I':	// random search
			task = 2;
			sscanf(optarg,"%d:%lf:%lf:%d",&cycleLen,&start,&stop,&niter);
			break;
		case 'i':	// step numbers of base formulas, "incremental" search
			task = 1;
			sscanf(optarg,"%lf:%lf:%lf",&start,&stop,&step);
			break;
		case 'l':	// linear combination
			fname = optarg;
			break;
		case 'o':	// output format
			outp = optarg[0];
			switch (outp) {
			case '3':
				prtf = js3d;
				break;
			case 'j':
				prtf = jsOutput;
				break;
			case 'p':
				prtf = plainOutput;
				break;
			default:
				printf("%s: output format %c unknown, only p (for plain) or j (for JavaScript) or 3 (for 3-dimensional) allowed\n",argv[0],outp);
				return 2;
			}
			break;
		case 'r':	// number of eigenvalue computations
			nr = atoi(optarg);
			if (nr < 0) {
				nr = 20;
				printf("%s: nr<0, silently set to %d\n",argv[0],nr);
			}
			break;
		//case 'T':	// test method on y' = lambda y
		//	task = 3;
		//	sscanf(optarg,"%lf:%lf:%lf:%lf:%lf",&radius,&phi,&start,&stop,&step);
		//	break;
		case 't':	// test method on y' = lambda y
			task = 3;
			sscanf(optarg,"%d:%lf:%lf:%lf:%lf:%lf",&prec,&radius,&phi,&start,&stop,&step);
			break;
		case 'u':	// test method on Runge's function leading to 1/(1+t^2)
			task = 4;
			sscanf(optarg,"%d:%lf:%lf:%lf",&prec,&start,&stop,&step);
			break;
		case 'W':
			widlw = fabs(atof(optarg));
			break;
		default:
			printf("%s: illegal option %c\n",argv[0],c);
			return 3;
		}
	}

	if (debug && task) printf("start=%f, stop=%f, step=%f, r=%f, phi=%f\n",start,stop,step,radius,phi);

	// Initialize for zggev_
	cmach[0] = 'E';
	eps = 10 * dlamch_(cmach);

	jobvl[0] = 'N';	// do not compute the left generalized eigenvectors
	jobvr[0] = 'N'; // do not compute the right generalized eigenvectors


	if (task == 2) {
		randomComb(bm,nr,cycleLen,niter,lnc,widlw,a0,a1,b0,b1,start,stop,print);
		return 0;
	}
	if (fname) {
		if ((fm = initFormula(fname,bm,lnc)) == NULL) return 4;
		if (task == 1) {
			searchComb(bm,fm,nr,lnc,widlw,a0,a1,b0,b1,start,stop,step,print);
			return 5;
		}
		linearComb(bm,fm,lnc);
	}

	if (fm == NULL) fm = &F[0];	// default formula
	//prtf = (outp == 'p') ? plainOutput : jsOutput;

	if (debug) {
		printf("nr=%d, eps=%g\n",nr,eps);
		printFormulas(F,NF);
	}



	if (task == 3) {
		if (prec == 1) solveTestEqSingle(fm,radius,phi,start,stop,step);
		else if (prec == 2) solveTestEq(fm,radius,phi,start,stop,step);
		else {
			printf("%s: illegal precision for -t, only 1 and 2 allowed, your prec=%d\n",argv[0],prec);
			return 5;
		}
		return 0;
	} else if (task == 4) {
		if (prec == 2) solveRunge(fm,start,stop,step);
		else if (prec == 3) solveRungeQuad(fm,start,stop,step);
		else {
			printf("%s: illegal precision for -u, only 2 and 3 allowed, your prec=%d\n",argv[0],prec);
			return 6;
		}
		return 0;
	}

	fillMatrices(fm,a0,a1,b0,b1,&n,&nsq);
	lda = n, ldb = n, ldvl = n, ldvr = n, lwork = n*n;
	if (lwork <= 1) lwork = 8;

	parasiticRoots(n,nsq,a0,a1,print,fm);

	if (nr > 0) {
		if (outp == 'j' || outp == '3') printf("var data_%s = [\n",fm->name);

		lambdaLocus(n,nsq,nr,0.0,a0,a1,b0,b1,&xmin,&xmax,&ymax,&widlw,prtf);

		if (outp == 'j') printf("];\nvar title_%s = { text: '%s:  p=%d, delta=%.6f, alpha=%.6f', left: 'center' };\n"
			"var chartDom_%s = document.getElementById('container_%s');\n"
			"var myChart_%s = echarts.init(chartDom_%s);\n"
			"var option_%s = { xAxis: {}, yAxis: {}, tooltip: { trigger: 'axis' }, title: title_%s, series: ["
				" { data: data_%s, symbolSize: 2, type: 'scatter' } ] };\n"
			"option_%s && myChart_%s.setOption(option_%s);\n\n",
			fm->name,fm->name,fm->p,xmin,widlw,
			fm->name,fm->name,
			fm->name,fm->name,
			fm->name,fm->name,fm->name,
			fm->name,fm->name,fm->name);
		else if (outp == '3') {	// 3D output, i.e., stability mountain
			printf("];\nvar data3d_%s = [\n",fm->name);
			lambda3D(n,nsq,nr,xmin,xmax,ymax,a0,a1,b0,b1);
			printf("];\n"
				"var option_%s = {\n"
				"\ttooltip: {},\n"
				"\tvisualMap: {\n"
				"\t\tshow: false,\n"
				"\t\tdimension: 2,\n"
				//"\t\tinRange: { color: [ '#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026' ] }\n"
				"\t},\n"
				"\txAxis3D: { type: 'value' },\n"
				"\tyAxis3D: { type: 'value' },\n"
				"\tzAxis3D: { type: 'value' },\n"
				"\tgrid3D: { viewControl: { projection:'perspective' } },\n"
				"\tseries: [\n"
				"\t\t{ type:'surface', wireframe: { show:true }, data: data3d_%s },\n"
				"\t\t{ type:'scatter3D', symbolSize:2, data: data_%s }\n"
				"\t]\n"
				"}\n"
				"var chartDom_%s = document.getElementById('container_%s');\n"
				"var myChart_%s = echarts.init(chartDom_%s);\n"
				"option_%s && myChart_%s.setOption(option_%s);\n\n",
				fm->name,
				fm->name,
				fm->name,
				fm->name,fm->name,
				fm->name,fm->name,
				fm->name,fm->name,fm->name);
		}
	}

	return 0;
}

